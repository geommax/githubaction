# Lesson 03: Multiple Jobs and Dependencies
#
# Concepts covered:
# - Multiple jobs in one workflow
# - Job dependencies (needs)
# - Job outputs
# - Parallel vs sequential execution
# - Job conditionals

name: Lesson 04 - Example of Multiple Jobs with Dependencies

on:
  workflow_dispatch:

jobs:
  # Job 1: Runs first (no dependencies)
  setup:
    name: Setup Job
    runs-on: ubuntu-latest
    outputs:
      build-time: ${{ steps.timestamp.outputs.time }}
      environment: ${{ steps.env-check.outputs.env }}
    
    steps:
      - name: Print job start
        run: echo "Setup job started."
      
      - name: Generate timestamp
        id: timestamp
        run: echo "time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      
      - name: Determine environment
        id: env-check
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "env=production" >> $GITHUB_OUTPUT
          else
            echo "env=development" >> $GITHUB_OUTPUT
          fi
  
  # Job 2 and 3: Run in parallel after setup
  build:
    name: Build Job
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Show build time
        run: |
          echo "Building at ${{ needs.setup.outputs.build-time }}"
          echo "Environment: ${{ needs.setup.outputs.environment }}"
      
      - name: Simulate build
        run: |
          echo "Compiling source code..."
          sleep 3
          echo "Build completed!"
  
  test:
    name: Test Job
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Show environment
        run: echo "Testing in ${{ needs.setup.outputs.environment }} environment"
      
      - name: Run tests
        run: |
          echo "Running unit tests..."
          sleep 2
          echo "All tests passed!"
  
  # Job 4: Runs after both build and test complete
  deploy:
    name: Deploy Job
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deploy application
        run: |
          echo "Deploying to production..."
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          sleep 2
          echo "Deployment successful!"
  
  # Job 5: Always runs, even if previous jobs fail
  notify:
    name: Notification Job
    runs-on: ubuntu-latest
    needs: [build, test, deploy]
    if: always()
    
    steps:
      - name: Send notification
        run: |
          echo "Workflow completed!"
          echo "Build status: ${{ needs.build.result }}"
          echo "Test status: ${{ needs.test.result }}"
          echo "Deploy status: ${{ needs.deploy.result }}"
