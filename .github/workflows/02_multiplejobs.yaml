name: Env Variable and multiple jobs Demo

on:
  push:
    branches:
      - main
      - develop

env:
  PROJECT_NAME: 'my project alpha'
  WORKFLOW_RUN_ID: ${{ github.run_id }}
  DEFAULT_TEST_RUNNER: 'kyawswartun test'

jobs:
  prepare-config:
    name: Prepare Configuration
    runs-on: ubuntu-latest
    outputs:
      test_command: ${{ steps.set_output.outputs.configured_command }}
      config_version: ${{ steps.set_output.outputs.config_version }}
    env:
      BUILD_ENV_STAGE: 'staging'
      TEST_FRAMEWORK_FLAG: '--silent'
    steps:
      - name: Display All Environment Variables
        run: |
          echo "--- Workflow-Level Vars ---"
          echo "Project: $PROJECT_NAME"
          echo "Run ID: $WORKFLOW_RUN_ID"
          
          echo "--- Job-Level Vars ---"
          echo "Stage: $BUILD_ENV_STAGE"
          echo "Flag: $TEST_FRAMEWORK_FLAG"
          
          echo "--- Default GHA Vars ---"
          echo "Runner OS: $RUNNER_OS"
          echo "---------------------------"

      - name: Set Job Outputs and Step Environment Variable
        id: set_output
        run: |
          # 1. Set a STEP-LEVEL env var for use in later steps within this job
          echo "MY_CONFIG_VERSION=v1.2.3" >> $GITHUB_ENV
          
          # 2. Set an OUTPUT variable for use in dependent jobs (Job 2)
          echo "configured_command=$DEFAULT_TEST_RUNNER --coverage $TEST_FRAMEWORK_FLAG" >> $GITHUB_OUTPUT
          echo "config_version=v1.2.3" >> $GITHUB_OUTPUT
      
      - name: Use Step Environment Variable
        run: echo "Configuration version $MY_CONFIG_VERSION"

  run-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: prepare-config
    steps:
      - name: Run Tests with Configured Command
        run: |
          # The full context path is needs.<job-id>.outputs.<output-id>
          TEST_CMD="${{ needs.prepare-config.outputs.test_command }}"
          CONFIG_VER="${{ needs.prepare-config.outputs.config_version }}"
          
          echo "--- Running Tests ---"
          echo "Project: $PROJECT_NAME" # Uses Workflow-Level Env
          echo "Config Version: $CONFIG_VER" # Uses Output from Job 1
          echo "Executing command: $TEST_CMD"
          
          # Execute the command (e.g., replace this with your actual test script)
          /bin/bash -c "$TEST_CMD"
          echo "Tests finished."