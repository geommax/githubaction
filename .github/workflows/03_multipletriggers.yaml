name: Lesson 03 - Multiple Triggers and Jobs Demo

on:
  # push:
  #   branches:
  #     - main
  #     - 'feature/*'
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run tests? (true/false)'
        required: true
        default: 'true'
      environment:
        description: 'Deployment environment (staging|production)'
        required: true
        default: 'staging'

env:
  PROJECT: 'my-example-app'

jobs:
  setup:
    name: Setup and Determine Flags
    runs-on: ubuntu-latest
    outputs:
      run_tests: ${{ steps.set.outputs.run_tests }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine whether to run tests
        id: set
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run_tests=${{ github.event.inputs.run_tests }}" >> $GITHUB_OUTPUT
          else
            echo "run_tests=true" >> $GITHUB_OUTPUT
          fi

  lint:
    name: Lint (parallel)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run linter
        run: |
          echo "Running linters for $PROJECT"

  unit-tests:
    name: Unit Tests (conditional, parallel with Lint)
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ needs.setup.outputs.run_tests == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run unit tests
        run: |
          echo "Running unit tests (project=$PROJECT)"

  integration-tests:
    name: Integration Tests (sequential)
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run integration tests
        run: |
          echo "Running integration tests"

  deploy:
    name: Deploy (needs and conditionals)
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: ${{ github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Deploy to environment
        run: |
          echo "Deploying $PROJECT"
          echo "Ref: $GITHUB_REF"
          echo "Triggered by: $GITHUB_EVENT_NAME"
