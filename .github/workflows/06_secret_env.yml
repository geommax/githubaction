name: lesson 06 - Secret, Env Vars & Contexts

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production

# Workflow-level environment variables
env:
  WORKFLOW_VAR: 'workflow-level-variable'
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  environment-variables-demo:
    name: Environment Variables Examples
    runs-on: ubuntu-latest
    # Job-level environment variables
    env:
      JOB_VAR: 'job-level-variable'
      DATABASE_NAME: 'myapp_db'
      API_ENDPOINT: 'https://api.example.com'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Display environment variables
        # Step-level environment variables
        env:
          STEP_VAR: 'step-level-variable'
          GREETING: 'Hello from GitHub Actions'
        run: |
          echo "=== Environment Variables Hierarchy ==="
          echo "Workflow level: $WORKFLOW_VAR"
          echo "Job level: $JOB_VAR"
          echo "Step level: $STEP_VAR"
          echo ""
          echo "=== Application Config ==="
          echo "Node version: $NODE_VERSION"
          echo "Database: $DATABASE_NAME"
          echo "API: $API_ENDPOINT"
      
      - name: Set custom environment variable
        # Set env var for subsequent steps
        run: |
          echo "CUSTOM_VAR=my-custom-value" >> $GITHUB_ENV
          echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
      
      - name: Use custom environment variable
        run: |
          echo "Custom variable: $CUSTOM_VAR"
          echo "Build time: $BUILD_TIME"


  github-contexts-demo:
    name: GitHub Contexts Examples
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Display github context
        run: |
          echo "=== GitHub Context ==="
          echo "Repository: ${{ github.repository }}"
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run number: ${{ github.run_number }}"
          echo "Job: ${{ github.job }}"
      
      - name: Display runner context
        run: |
          echo "=== Runner Context ==="
          echo "OS: ${{ runner.os }}"
          echo "Architecture: ${{ runner.arch }}"
          echo "Name: ${{ runner.name }}"
          echo "Temp directory: ${{ runner.temp }}"
          echo "Tool cache: ${{ runner.tool_cache }}"
          echo "Workspace: ${{ runner.workspace }}"
      
      - name: Display env context
        run: |
          echo "=== Env Context ==="
          echo "Workflow var: ${{ env.WORKFLOW_VAR }}"
          echo "Node version: ${{ env.NODE_VERSION }}"
      
      - name: Display job context
        run: |
          echo "=== Job Context ==="
          echo "Status: ${{ job.status }}"
          echo "Container ID: ${{ job.container.id }}"
      
      - name: Conditional execution based on context
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "This runs only on push to main branch"
      
      - name: Use inputs context (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Selected environment: ${{ inputs.environment }}"


  secrets-demo:
    name: Secrets Handling Examples
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Using secrets safely
        env:
          # Secrets should be passed as environment variables
          # NEVER echo or print secrets directly
          API_KEY: ${{ secrets.API_KEY }}
          DATABASE_PASSWORD: ${{ secrets.DB_PASSWORD }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "=== Secrets Usage ==="
          echo "✓ API Key is set: ${API_KEY:+YES}"
          echo "✓ Database password is set: ${DATABASE_PASSWORD:+YES}"
          echo "✓ AWS credentials are set: ${AWS_ACCESS_KEY:+YES}"
  
      - name: Mask sensitive values
        run: |
          # If you generate sensitive values at runtime, mask them
          GENERATED_TOKEN="ghp_$(openssl rand -hex 16)"
          echo "::add-mask::$GENERATED_TOKEN"
          echo "Token generated: $GENERATED_TOKEN"

  # JOB 4: Matrix Strategy with Variables
  matrix-demo:
    name: Matrix Build (${{ matrix.os }} - ${{ matrix.language }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        language: [node, python]
        include:
          - language: node
            version: '18'
          - language: python
            version: '3.11'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Display matrix variables
        run: |
          echo "OS: ${{ matrix.os }}"
          echo "Language: ${{ matrix.language }}"
          echo "Version: ${{ matrix.version }}"

  # ============================================================================
  # JOB 5: Outputs and Dependencies
  # ============================================================================
  generate-outputs:
    name: Generate Outputs
    runs-on: ubuntu-latest
    
    outputs:
      build-version: ${{ steps.version.outputs.version }}
      build-date: ${{ steps.date.outputs.date }}
      artifact-name: ${{ steps.artifact.outputs.name }}
    
    steps:
      - name: Generate version
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Generate date
        id: date
        run: |
          DATE=$(date +'%Y%m%d')
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Generated date: $DATE"
      
      - name: Generate artifact name
        id: artifact
        run: |
          ARTIFACT="app-${{ github.sha }}"
          echo "name=$ARTIFACT" >> $GITHUB_OUTPUT
          echo "Generated artifact name: $ARTIFACT"

  use-outputs:
    name: Use Job Outputs
    runs-on: ubuntu-latest
    needs: generate-outputs
    
    steps:
      - name: Display outputs from previous job
        run: |
          echo "=== Job Outputs ==="
          echo "Version: ${{ needs.generate-outputs.outputs.build-version }}"
          echo "Date: ${{ needs.generate-outputs.outputs.build-date }}"
          echo "Artifact: ${{ needs.generate-outputs.outputs.artifact-name }}"

  # ============================================================================
  # JOB 6: Advanced Context Usage
  # ============================================================================
  advanced-contexts:
    name: Advanced Context Patterns
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Parse event data (push)
        if: github.event_name == 'push'
        run: |
          echo "=== Push Event Data ==="
          echo "Commit message: ${{ github.event.head_commit.message }}"
          echo "Committer: ${{ github.event.head_commit.committer.name }}"
          echo "Compare URL: ${{ github.event.compare }}"
      
      - name: Parse event data (pull_request)
        if: github.event_name == 'pull_request'
        run: |
          echo "=== Pull Request Event Data ==="
          echo "PR number: ${{ github.event.number }}"
          echo "PR title: ${{ github.event.pull_request.title }}"
          echo "PR author: ${{ github.event.pull_request.user.login }}"
          echo "Base branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head branch: ${{ github.event.pull_request.head.ref }}"
      
      - name: Working with paths
        run: |
          echo "=== Path Operations ==="
          echo "Workspace: ${{ github.workspace }}"
          echo "Home: $HOME"
          echo "Runner temp: ${{ runner.temp }}"
      
      - name: String operations with contexts
        run: |
          echo "=== String Operations ==="
          echo "Lowercase ref: ${{ github.ref_name }}"
          echo "SHA short: ${GITHUB_SHA::7}"
          
          # Create sanitized branch name for Docker tags
          BRANCH_NAME="${{ github.ref_name }}"
          SANITIZED=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "Sanitized branch: $SANITIZED"

  # ============================================================================
  # JOB 7: Environment-specific deployment
  # ============================================================================
  deploy:
    name: Deploy to ${{ matrix.environment }}
    runs-on: ubuntu-latest
    
    # Use GitHub Environments for protection rules and secrets
    environment:
      name: ${{ matrix.environment }}
      url: https://${{ matrix.environment }}.example.com
    
    strategy:
      matrix:
        environment: [development, staging]
    
    env:
      DEPLOY_ENV: ${{ matrix.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy application
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          ENV_SPECIFIC_VAR: ${{ secrets.ENV_SPECIFIC_VAR }}
        run: |
          echo "=== Deployment Info ==="
          echo "Deploying to: $DEPLOY_ENV"
          echo "Environment URL: https://$DEPLOY_ENV.example.com"
          echo "Deploy token configured: ${DEPLOY_TOKEN:+YES}"
          
          # Actual deployment commands would go here
          # Example: ./deploy.sh --env $DEPLOY_ENV --token $DEPLOY_TOKEN

